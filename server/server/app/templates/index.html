<!DOCTYPE html>
<html>
<head>
    <title>设备列表</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .device-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .device-card.selected {
            border: 3px solid #28a745;
        }
        .device-screenshot {
            width: 100%;
            height: 200px;
            object-fit: contain;
            cursor: pointer;
        }
        .screenshot-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .screenshot-modal img {
            max-width: 100%;
            max-height: 100%;
        }
        .console-window {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            font-family: monospace;
            display: flex;
            flex-direction: column;
        }
        .console-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: #2d2d2d;
        }
        .console-input {
            display: flex;
            gap: 10px;
        }
        .console-input input {
            flex: 1;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #fff;
            padding: 5px 10px;
        }
        .console-line {
            margin: 5px 0;
            word-wrap: break-word;
        }
        .console-command {
            color: #4CAF50;
        }
        .console-response {
            color: #2196F3;
        }
        .console-error {
            color: #f44336;
        }
        .main-content {
            margin-bottom: 320px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div id="app">
            <div class="main-content">
                <h2>设备列表</h2>
                <div class="row">
                    <div class="col-md-4" v-for="(device, id) in devices" :key="id">
                        <div class="card mb-3 device-card" 
                             :class="{'selected': selectedDevice === id}"
                             @click="selectDevice(id)">
                            <div class="card-body">
                                <h5 class="card-title">设备ID: [[ id ]]</h5>
                                <p class="card-text">状态: [[ device.status ]]</p>
                                <p class="card-text">最后在线: [[ formatTime(device.last_seen) ]]</p>
                                <img :src="device.screenshot || '/static/screenshots/default.jpg'"
                                     class="device-screenshot mb-3"
                                     @click.stop="showFullScreenshot(device)"
                                     :title="device.status === 'online' ? '点击查看大图' : '设备离线'">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 命令控制台 -->
            <div class="console-window">
                <div class="console-history" ref="consoleHistory">
                    <div v-for="(log, index) in commandLogs" :key="index" class="console-line">
                        <template v-if="log.type === 'command'">
                            <span class="console-command">> [[ log.deviceId ]]: [[ log.content ]]</span>
                        </template>
                        <template v-else-if="log.type === 'response'">
                            <span class="console-response">[[ log.content ]]</span>
                        </template>
                        <template v-else>
                            <span class="console-error">[[ log.content ]]</span>
                        </template>
                    </div>
                </div>
                <div class="console-input">
                    <input type="text" v-model="commandInput" 
                           @keyup.enter="sendCommand"
                           :placeholder="selectedDevice ? `输入命令 (发送给 ${selectedDevice})` : '请先选择设备'"
                           :disabled="!selectedDevice">
                    <button class="btn btn-primary" 
                            @click="sendCommand"
                            :disabled="!selectedDevice">
                        发送
                    </button>
                </div>
            </div>

            <!-- 全屏截图模态框 -->
            <div class="screenshot-modal" v-if="fullScreenshot" @click="fullScreenshot = null">
                <img :src="fullScreenshot" @click.stop>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data: {
                devices: {{ initial_devices | tojson | safe }},
                selectedDevice: null,
                fullScreenshot: null,
                commandInput: '',
                commandLogs: []
            },
            methods: {
                formatTime(timestamp) {
                    if (!timestamp) return '未知';
                    return new Date(timestamp).toLocaleString();
                },
                updateDeviceList(devices) {
                    console.log('设备列表更新:', devices);
                    const selected = this.selectedDevice;
                    this.devices = devices;
                    this.selectedDevice = selected;
                },
                selectDevice(deviceId) {
                    this.selectedDevice = this.selectedDevice === deviceId ? null : deviceId;
                },
                showFullScreenshot(device) {
                    if (device.status === 'online' && device.screenshot) {
                        this.fullScreenshot = device.screenshot;
                    }
                },
                sendCommand() {
                    if (!this.commandInput || !this.selectedDevice) return;
                    
                    const device = this.devices[this.selectedDevice];
                    if (!device || device.status !== 'online') {
                        this.addLog('error', '设备离线，无法发送命令');
                        return;
                    }

                    // 添加命令到日志
                    this.addLog('command', this.commandInput, this.selectedDevice);
                    
                    // 发送命令到服务器
                    this.socket.emit('send_command', {
                        device_id: this.selectedDevice,
                        command: this.commandInput
                    });
                    
                    // 清空输入
                    this.commandInput = '';
                },
                addLog(type, content, deviceId = null) {
                    this.commandLogs.push({ type, content, deviceId });
                    this.$nextTick(() => {
                        const consoleHistory = this.$refs.consoleHistory;
                        consoleHistory.scrollTop = consoleHistory.scrollHeight;
                    });
                }
            },
            mounted() {
                this.socket = io();
                this.socket.on('connect', () => {
                    console.log('连接到服务器');
                });
                
                this.socket.on('device_list_update', (devices) => {
                    this.updateDeviceList(devices);
                });

                // 监听命令响应
                this.socket.on('command_result', (data) => {
                    this.addLog('response', 
                        `${data.status === 'success' ? '成功' : '失败'}: ${data.result}`);
                });

                this.socket.on('error', (data) => {
                    this.addLog('error', data.message);
                });
            }
        });
    </script>
</body>
</html> 