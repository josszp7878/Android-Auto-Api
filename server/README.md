# Android 远程控制系统

一个基于 WebSocket 的 Android 设备远程控制系统，支持多设备管理和命令执行。

## 系统架构

### 服务端 (server/)
- Flask + Flask-SocketIO 提供 WebSocket 服务
- Vue.js + Bootstrap 实现 Web 控制台
- SQLite 数据库保存设备信息

### 客户端 (client/)
- Python SocketIO 客户端
- 支持命令行测试和 Android 集成模式
- 基于 Chaquopy 实现 Python-Java 交互

## 核心功能

### 1. 设备管理
- 设备自动注册和状态监控
- 多设备并行管理
- 设备状态持久化存储

### 2. 命令系统
- 支持命令行测试和 APP 集成两种模式
- 内置多种设备控制命令：
  * 点击 <x> <y>: 模拟点击
  * 屏幕内容: 获取屏幕文本
  * 返回/主屏幕: 导航控制
  * 应用管理: 打开/关闭/安装/卸载
  * 截屏: 屏幕截图

### 3. Web 控制台
- 实时设备列表显示
- 命令输入和执行
- 命令历史记录
- 执行结果实时反馈

## 最近更新

### 1. 命令系统重构
- 添加条件编译支持
- 实现命令注册机制
- 支持命令行测试模式

### 2. 设备管理优化
- 改进设备状态同步
- 优化设备连接机制
- 添加设备信息持久化

### 3. 界面优化
- 添加命令控制台
- 优化设备选择机制
- 改进命令响应显示

## 待开发功能
1. 设备截图预览
2. 设备状态定时检查
3. 命令执行历史记录
4. 批量命令执行

## 更新日志

### 2023年10月15日

- 修复了命令历史显示顺序的问题，现在最近的命令显示在最下面。
- 优化了设备状态的同步逻辑，避免了不必要的数据库提交。
- **新增**：支持服务器端命令。现在可以通过 `@` 开头的命令直接在服务器端执行。

### 2023年12月27日

- **合并功能**：文件服务器功能已合并到主服务器中，现在可以通过单一入口启动所有服务。
- **连接测试**：手机终端测试连接服务器成功，确保了客户端与服务器的稳定通信。

### 2023年12月28日

- **新增**：在 `ScriptEngine` 中添加 `uninit` 方法，用于在应用退出时调用 `main.py` 的 `End` 方法进行清理。
- **更新**：在 `MainActivity` 的 `onDestroy` 方法中调用 `ScriptEngine` 的 `uninit` 方法。

### 2023年12月29日

- **重构**: 将日志相关功能从 Tools 类移至 Device 类,实现更合理的职责划分
- **优化**: 统一了日志输出机制,支持Android和命令行两种环境
- **新增**: 服务器命令支持忽略大小写的模糊匹配
- **新增**: 添加 @echo 命令用于测试日志输出

### 2023年12月30日

- **重构**: 整合文件服务器到主服务器,简化系统架构
- **优化**: 移除命令行控制台,统一使用 Web 界面进行操作
- **改进**: 所有服务集成到单一进程,提高系统稳定性

### 2023年12月31日

- **重构**: 重新设计日志系统
  * 统一客户端和服务器的日志接口(Device.i/w/e)
  * 支持日志实时显示和历史记录
  * 日志按时间倒序显示，最新的显示在底部
  * 日志分级显示(INFO/WARN/ERROR)，使用不同颜色区分
- **优化**: 改进设备类的单例实现
  * 修复设备ID初始化问题
  * 优化参数传递机制
  * 添加设备状态管理
- **改进**: Web界面交互优化
  * 添加日志自动滚动功能
  * 支持历史日志分页加载
  * 优化日志显示样式

### 2024-03-xx

#### 命令系统重构
- 优化命令匹配机制：
  * 分离命令名匹配和参数匹配
  * 支持命令模式匹配和方法名模糊匹配
  * 优先使用模式匹配，再尝试方法名前缀匹配
  * 统一的参数验证机制
- 改进错误处理：
  * 区分命令错误和参数错误
  * 区分测试模式和App模式的错误提示
  * 添加调试级别日志(蓝色)
- 优化代码结构：
  * 统一命令注册方式
  * 支持无参数和带参数的命令定义
  * 改进命令执行流程

## 使用说明

- 运行 `server.bat` 或 `python MyServer.py` 启动服务器
- 通过 Web 界面(http://localhost:5000)进行所有操作
- 使用 `@` 开头的命令执行服务器操作
- 所有日志和操作历史都在 Web 界面显示

## 贡献指南

- 提交代码时，请确保所有更改都经过测试。
- 使用 `master` 分支进行提交。

## 最新更新

### 热加载功能优化
1. 重构了模块重载逻辑
   - 分离了重载流程为多个独立函数
   - 添加了 OnPreload 和 OnReload 回调
   - 优化了错误处理和状态管理

2. 改进了连接机制
   - 优化了 Socket.IO 连接配置
   - 添加了设备 ID 冲突检测
   - 提供了更友好的错误提示

3. 代码结构优化
   - 重构了 Tools 类，职责更清晰
   - 优化了日志系统的初始化流程
   - 改进了平台判定机制

### 主要改动
1. tools.py
   - 拆分复杂的重载逻辑为多个函数
   - 添加了详细的函数文档
   - 优化了错误处理流程

2. CDevice.py
   - 改进了 Socket.IO 连接配置
   - 添加了更多的连接选项
   - 优化了错误提示信息

3. logger.py
   - 优化了日志目录处理
   - 改进了平台判定逻辑
   - 统一了日志输出格式

### 使用说明
1. 热加载模块时会自动调用：
   - OnPreload: 重载前的状态保存
   - OnReload: 重载后的状态恢复

2. 设备连接注意事项：
   - 设备 ID 必须唯一
   - 同一设备 ID 不能重复连接
   - 连接失败时会提供具体原因

### 连接错误修复
- 添加 CORS 支持，允许跨域请求
- 优化 WebSocket 连接配置
- 添加连接错误处理和日志记录
- 规范化命名风格，移除下划线命名

### 使用说明
1. 确保服务器端口 5000 未被占用
2. 检查设备 ID 格式是否正确
3. 连接 URL 格式: http://localhost:5000?device_id=设备ID

### 连接故障排查
1. 确认服务器状态
   - 检查服务器是否正常运行
   - 确认端口 5000 未被占用
   - 查看服务器日志是否有错误信息

2. 检查设备连接参数
   - 设备ID格式是否正确
   - URL格式: http://localhost:5000?device_id=设备ID
   - 确保设备ID在URL中正确编码

3. 常见错误解决
   - 跨域问题：确认CORS配置正确
   - 连接超时：检查网络状态和防火墙设置
   - 命名空间错误：确保客户端和服务器使用相同的命名空间

# 重要更新日志

## 平台判定和文件系统优化
1. 重构了平台判定逻辑
   - 将平台判定统一到 Tools 类中管理
   - 简化了 Android 平台检测机制
   - 移除了重复的平台判定代码

2. 优化了文件系统访问
   - 添加了 PythonServices.getFilesDir() 方法获取应用私有目录
   - 修复了 Android 平台日志文件路径问题
   - 确保日志文件存储在应用私有目录中

3. 代码结构优化
   - 移除了 CmdMgr 中的 Android 相关代码
   - 统一使用 Tools 类管理平台相关功能
   - 简化了初始化流程

4. 错误处理改进
   - 优化了日志系统初始化流程
   - 添加了更详细的错误提示
   - 改进了平台兼容性处理

## 主要文件变更
1. tools.py
   - 添加了单例模式实现
   - 添加了 Android 平台判定和接口访问功能
   - 优化了方法命名和代码结构

2. logger.py
   - 修改日志目录获取逻辑
   - 优化了初始化流程
   - 添加了调试日志输出

3. PythonServices.kt
   - 添加了 getFilesDir 方法
   - 优化了文件路径处理

4. client.py
   - 优化了初始化流程
   - 使用 Tools 类进行平台判定

## 遗留问题
- AutoServiceUnavailableException 问题需要进一步处理
- 需要完善无障碍服务的初始化和状态检查

## 注意事项

1. 设备ID必须唯一，同一时间内不能有两个客户端使用相同的设备ID连接服务器
2. 如果收到"设备ID已被使用"的提示，请更换一个新的设备ID后重试
3. 建议使用有意义的设备ID，便于识别和管理