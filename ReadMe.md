# Android Auto API

## 更新日志

### 2024-08-06
- 优化设备表及目标设备管理机制
  - 隐藏设备表ID列，保留id属性用于后台识别
  - 修改目标设备机制，使用deviceId而非id存储目标设备
  - 启用表格选择状态持久化机制，移除冗余的选择状态跟踪
  - 优化发送命令流程，优先使用目标设备，其次使用选中设备

### 2024-08-05
- 修复设备表相关问题
  - 修复设备表缺少ID列显示的问题，在prepareDeviceData函数中增加deviceId字段
  - 解决设置设备为目标后设备ID列内容消失的问题
  - 确保设备ID列在设备变为目标设备后仍能正常显示

### 2024-07-29
- 重构控制台连接管理机制
  - 将控制台连接也作为SDevice_类型进行管理，设备ID以@开头
  - 将_consoles从set改为Dict[str, SDevice_]，键为SID，值为SDevice_实例
  - 数据库加载时过滤掉控制台ID，不加载到普通设备列表中
  - 为控制台添加单独的状态管理，支持显示在线/离线/登录状态
  - 改进handleB2SLoadDevices，分别发送设备和控制台数据
  - 支持控制台登录功能，登录后状态从online变为login
  - 控制台设备变更时自动发送S2B_sheetUpdate事件更新前端
  - 提高了控制台连接的可跟踪性和可管理性

### 2024-07-28
- 优化设备状态管理
  - 创建统一的设备状态定义(deviceStatusMap)，包含状态值、标签、颜色和图标
  - 修正设备状态处理逻辑，确保正确显示"login"和"logout"状态
  - 改进状态过滤器，从统一定义中动态构建过滤选项
  - 统一状态显示格式，提高代码可维护性
  - 动态生成状态格式化参数，确保UI呈现与状态定义一致
  - 修复在状态处理中缺失login/logout导致显示问题的bug
  - 优化数据验证逻辑，使用统一的有效状态列表
- 优化日志等级管理
  - 创建统一的日志等级定义(logLevelMap)，包含等级值、标签、颜色和图标
  - 使用统一定义生成等级过滤器选项和格式化参数
  - 简化formatter函数实现，直接使用预定义格式化模板
  - 改进等级验证逻辑，使用统一的有效等级列表
  - 统一等级显示风格，提高视觉一致性和代码可维护性
  - 修复日志等级验证中的默认值设置
- 修复日志数据加载问题
  - 解决SQLAlchemy查询语法错误：'SQLAlchemy' object has no attribute 'query'
  - 修改_getLogs函数，正确使用LogModel_.query而不是db.query
  - 优化handleB2SLoadLogs函数，增加异常处理机制
  - 添加两级容错：优先使用toDict方法，失败时手动构建字典
  - 完善日志处理，记录转换失败项并跳过
  - 返回加载日志数量信息，便于调试

### 2024-07-27
- 优化表格过滤器功能
  - 为设备状态、日志标签和日志等级过滤器添加"全部"选项
  - 设备状态过滤器增加"已登录"和"已登出"选项
  - 日志标签过滤器改为下拉选择模式，包含所有可能的标签类型
  - 将日志标签和设备状态转为枚举类型，增加代码可维护性
  - 优化过滤器默认行为，支持查看全部数据
  - 提升数据筛选的灵活性和用户体验

### 2024-07-26
- 增强Socket.IO事件调试功能
  - 添加通用事件监听器，记录所有接收到的未处理事件
  - 在服务启动时打印所有已注册的事件处理器列表
  - 增加Socket.IO事件处理函数的调试日志
  - 添加请求源信息和SID记录，帮助定位事件来源
  - 改进handleB2SLoadLogs函数，添加明确的响应反馈
  - 发送S2B_logsLoadStatus事件通知前端请求处理状态
  - 增强异常处理，确保错误信息正确传回前端

### 2024-07-25
- 修复表格日期过滤器错误
  - 解决"No such editor found: date/datetime"错误
  - 将自定义过滤器类型(dateInput, datetimeInput, timeInput)替换为标准input类型
  - 保留日期和时间格式提示，在占位符中显示格式说明
  - 为所有日期时间过滤器添加格式提示，如"YYYY-MM-DD"
  - 保留单元格编辑器的日期和时间格式化功能
  - 确保与现有的默认过滤器设置兼容
  - 提高表格过滤功能的兼容性和稳定性

- 修复日志系统中的Eventlet协程错误
  - 解决"Cannot switch to MAINLOOP from MAINLOOP"错误
  - 将标准线程(threading.Thread)替换为Eventlet的协程(eventlet.spawn)
  - 修改日志保存和加载方法中的异步处理逻辑
  - 避免在Eventlet主循环中启动可能阻塞的线程
  - 完善错误处理和日志记录
  - 提高了在Eventlet环境下的兼容性和稳定性
  - 确保Socket.IO服务器能够正常关闭而不抛出异常

### 2024-07-24
- 改进表格日期和时间过滤功能
  - 将日期列过滤器从普通文本输入改为日期选择器(dateInput)
  - 将时间列过滤器从普通文本输入改为时间选择器(timeInput)
  - 将日期时间列过滤器改为日期时间选择器(datetimeInput)
  - 为所有日期和时间过滤器添加输入格式配置
  - 为过滤器添加占位符提示，提高用户体验
  - 确保与现有的默认过滤器设置兼容
  - 提升了日期和时间筛选功能的易用性和准确性

### 2024-07-23
- 优化日志系统，移除本地文件存储
  - 移除与本地日志文件加载和保存相关的逻辑，全部使用数据库存储
  - 删除_path方法和APP_LOGS常量，不再需要本地文件路径
  - 使用线程执行数据库操作，避免Socket.IO主事件循环中的阻塞操作
  - 修复服务器停止时出现的"do not call blocking functions from the mainloop"错误
  - 改进handleB2SLoadLogs函数，使用异步方式加载日志数据
  - 确保Socket.IO连接正确设置client_type参数
  - 提高日志系统稳定性和性能

### 2024-07-22
- 优化日志系统，解决循环引用问题
  - 将LogModel_类集成到_Log.py文件中，不再从SModels导入
  - 修改日志查找机制，使用循环遍历替代get方法
  - 添加日志重复检测和计数功能，重复日志增加count字段
  - 完善日志ID生成算法，基于tag+level+message+time计算哈希值
  - 增加条件检查，确保只有在必要时才发送Socket通知
  - 优化数据库查询逻辑，使用Database.sql方法执行查询
  - 修复缺失time参数时的默认处理逻辑

### 2024-07-21
- 增强数据验证和规整功能
  - 新增toSheetData方法，确保数据符合表格列定义要求
  - 自动过滤不需要的数据字段，只保留表格列定义中的字段
  - 为缺失字段设置合适的默认值，如状态、进度、得分等
  - 对数据字段进行类型和值范围验证，标记错误数据为"ERR"
  - 过滤掉没有id字段的无效数据项
  - 确保状态字段值在预定义范围内
  - 为数值字段(progress, score)添加类型转换和范围限制
  - 在控制台记录数据处理中的警告和错误
  - 修改updateData方法，使用toSheetData处理输入数据

### 2024-07-20
- 优化表格页面初始化逻辑
  - 移除SheetPage构造函数中的initialDevices和tasksData参数
  - 所有数据集统一初始化为空数组
  - 完全依赖Socket通信机制获取数据，实现数据更新与渲染分离
  - 减少构造函数参数，提高代码清晰度
  - 使界面渲染与数据加载更加独立，符合关注点分离原则
  - 简化页面初始化流程，统一数据获取方式

### 2024-07-19
- 统一数据结构，简化数据处理逻辑
  - 所有数据统一使用数组格式，移除对象格式的支持
  - 简化updateData方法，专注处理数组类型数据
  - 对初始设备数据添加类型检查，确保始终为数组格式
  - 优化prepareDeviceData方法，无需处理多种数据格式
  - 统一表格数据更新逻辑，直接使用原始数据更新表格
  - 移除多余的条件判断，使代码更加简洁高效

### 2024-07-18
- 优化数据更新相关代码
  - 将三个数据更新方法(updateTasksData, updateDevicesData, updateLogsData)合并为一个通用的updateData方法
  - 通过参数区分不同的数据类型和处理逻辑
  - 新增getTabNameByDataType工具方法，根据数据类型获取对应的标签页名称
  - 减少代码冗余，提高代码复用性和可维护性
  - 统一数据更新逻辑，简化条件判断流程
  - 保持相同的功能，同时提高了代码质量

### 2024-07-17
- 优化Socket通信机制
  - 将多个更新事件(S2B_tasksUpdate, S2B_deviceUpdate, S2B_logsUpdate)合并为统一的S2B_sheetUpdate事件
  - 实现根据数据类型(tasks, devices, logs)自动更新对应数据集的功能
  - 添加支持增量更新的机制，根据对象ID判断是更新还是新增
  - 任务操作命令(执行、暂停、取消)统一改为B2S_cmd格式，并指定设备ID
  - 简化B2S_loadTasks等加载事件的过滤器，仅保留日期过滤
  - 新增updateTasksData、updateDevicesData和updateLogsData方法处理不同类型数据更新
  - 优化数据更新流程，提高前后端数据同步效率

### 2024-07-16
- 重构表格数据类型管理
  - 添加 DataType 枚举定义，规范化数据类型的使用
  - 修改所有使用字符串类型的地方，改用枚举值
  - 优化 tabTypeMap 映射表，使用枚举值作为数据类型
  - 更新所有表格相关方法，统一使用 DataType 枚举
  - 修复过滤器事件处理，改用 dataFiltered 事件
  - 完善过滤器参数收集逻辑，支持所有类型的过滤条件

### 2024-07-15
- 重构表格相关文件命名和功能
  - 将 Tasks.js 和 Tasks.html 重命名为 Sheet.js 和 Sheet.html
  - 在表格中添加新的"日志"标签页，显示系统日志数据
  - 为所有表格中的日期和时间字段启用专用的日期和时间编辑器
  - 任务表中的进度已使用进度条显示（之前已存在）
  - 重命名相关类名，从 TaskPage 改为 SheetPage
  - 优化日志表结构，包含日期、时间、标签、等级、发送者和内容字段
  - 添加Socket事件监听，支持日志数据的实时更新
- 修复表格初始化问题：解决在表格完全构建前调用getHeaderFilters方法导致的错误
- 优化表格数据加载流程，确保在表格初始化完成后再加载数据
- 改进过滤器处理逻辑，增强表格组件的稳定性

### 2024-07-11
- 优化事件监听器性能
  - 添加 {passive: true} 选项到所有事件监听器
  - 消除浏览器"non-passive event listener"警告
  - 提高页面滚动性能和响应速度
  - 优化了标签页切换按钮、上下文菜单和外部点击事件处理
  - 遵循现代浏览器最佳实践，避免阻塞滚动线程

### 2024-07-10
- 修复设备表格状态显示和标签切换问题
  - 修复设备表状态列lookup格式化器的"Missing display value for offline"错误
  - 改进设备数据处理，确保状态值始终为"online"或"offline"
  - 完全重构标签页切换逻辑，采用表格重建方式而非动态更新列和数据
  - 解决了修改列定义和加载数据顺序导致的问题
  - 优化表格初始化流程，确保数据和列定义完全匹配
  - 使用destroy()和重建表格的方式，替代之前不可靠的setColumns和setData调用

### 2024-07-09
- 修复标签页布局和数据加载问题
  - 将标签页按钮靠左对齐排列，而非居中
  - 修复切换标签页后数据消失的bug
  - 优化数据加载流程，使用setTimeout和Promise确保数据正确加载
  - 移除冗余的clearData调用，防止数据丢失
  - 添加左侧内边距，提升标签页整体布局美观度
  - 调整标签按钮使用margin-right而非margin来保持一致的间距

### 2024-07-08
- 优化自定义标签页风格和结构
  - 简化标签页，移除设备视图标签，仅保留任务和设备两个标签
  - 重新设计标签页风格，采用深色主题与表格匹配：黑底白字，深绿色边框
  - 当前选中标签使用粗体字体和浅绿色边框提供视觉反馈
  - 添加过渡动画效果，提升用户体验
  - 调整标签页间距和内边距，优化整体布局
  - 减少不必要的代码逻辑，提高性能

### 2024-07-07
- 重构表格视图，用自定义标签页替代spreadsheet模式
  - 移除spreadsheet模式，改用自定义标签页UI实现多视图切换
  - 在表格底部添加切换按钮（任务、设备、设备视图）
  - 恢复分页功能，支持每个视图独立分页
  - 使用setColumns和setData动态切换表格内容
  - 增加标签页切换视觉反馈（颜色变化）
  - 重组代码结构，抽取设备数据和列定义为独立方法
  - 在标签切换时自动应用过滤器
  - 设置表格高度为calc(100% - 40px)，为标签栏预留空间

### 2024-07-06
- 修复表格视图模块兼容性问题
  - 解决了错误：The spreadsheet module is not compatible with the pagination module
  - 移除了pagination配置，包括pagination、paginationSize和paginationSizeSelector
  - 保留表格的spreadsheet模式，确保任务和设备表格标签页正常工作
  - 优化表格显示，实现任务和设备数据的切换显示
  - 确保过滤和排序功能继续工作

### 2024-07-05
- 修复表格视图数据类型错误
  - 修复了表格数据非数组类型导致的"s.forEach is not a function"错误
  - 在TaskPage类中增加数据类型检查和转换，确保tasks始终是数组类型
  - 在构造函数和socket事件监听中增加数据类型检查和转换
  - 在initMainTable方法中添加额外的数组检查，防止非数组数据导致的错误
  - 优化了数据处理逻辑，提高表格渲染的稳定性和可靠性

### 2024-07-01
- 改进表格视图，使用Tabulator原生标签页API
  - 修复表格视图同时显示任务表和设备表的问题，改为使用原生标签页
  - 使用spreadsheet:true和spreadsheetSheetTabs:true开启标签页功能 
  - 将标签页位置从顶部移到底部，符合Tabulator电子表格默认布局
  - 删除自定义标签页样式，使用Tabulator库的默认黑色主题
  - 优化表格布局，使其填满整个可用空间
  - 修改applyDateFilter方法，使用getModule("spreadsheet")获取标签页

### 2024-12-35
- 优化任务表格视图界面
  - 修复表格视图同时显示任务表和设备表的问题，改为默认只显示任务表
  - 使用Tabulator库自带的标签页功能，替代自定义HTML标签页
  - 应用Tabulator的默认表格样式，提供更一致的用户体验
  - 优化表格布局，使其填满整个可用空间，消除空白区域
  - 修改HTML容器类为container-fluid，确保全屏显示
  - 调整表格高度计算，使用calc(100vh - 20px)最大化利用空间
  - 将自定义格式化器替换为Tabulator内置的lookup格式化器
  - 增加initialPage配置，确保默认加载"任务"标签页

### 2024-12-34
- 将默认导航视图改为表格视图
  - 将index.html改名为deviceList.html
  - 修改路由配置，使任务表格成为默认主页
  - 添加/device路由用于访问设备列表视图
  - 调整导航链接，确保可以在视图间正确切换
  - 优化导航结构和用户体验

### 2024-12-33
- 新增表格视图功能，支持任务和设备数据表格化展示
  - 集成Tabulator表格库，实现高级表格功能
  - 添加新的表格视图界面，与设备视图并存
  - 实现任务表和设备表两种表格展示
  - 每个字段支持排序和过滤功能
  - 生命列支持直接编辑
  - 进度列以进度条方式显示
  - 右键菜单支持任务执行、暂停、取消操作
  - 设备和任务表格数据实时同步更新
  - 优化表格UI，提供更直观的数据展示

### 2024-12-32
- 后台日志输出到数据库功能
  - 创建新的LogModel数据库模型，用于存储后台日志
  - 保留前台日志输出到JSON文件的功能不变
  - 修改_Log.py中的Blog方法，支持将日志同时保存到数据库
  - 添加_save_log_to_db和_update_log_in_db方法，实现日志数据库操作
  - 优化日志重复判断逻辑，在数据库中也保持日志计数功能
  - 增强了日志系统与平台日志显示的兼容性
  - 通过数据库存储，提高了日志的查询性能和稳定性

### 2024-12-31
- 优化任务管理机制，修复任务暂停和恢复问题
  - 修改CTask_类的begin方法，确保在恢复任务时重置_lastTime并调用_goPage
  - 优化_refreshProgress方法，支持任务暂停后再次开始时累计计算进度
  - 在时间模式下，使用当前会话运行时间累加到总进度中
  - 在次数模式下，利用_execCount的累加特性计算进度
  - 增强了stop方法的注释，明确说明暂停任务的功能和返回值
  - 提高了任务暂停和恢复功能的可靠性和准确性

- 统一客户端和服务端任务状态管理
  - 将TaskState枚举类移至_G.py中作为共享枚举
  - 修改CTask_类和STask_类，统一使用_G中的TaskState枚举
  - 将toTaskId方法从_Tools移至_G中，保证任务ID一致性
  - 修改_end方法，根据任务返回结果决定是设置SUCCESS还是FAILED状态
  - 提高了客户端和服务端任务状态的一致性
  - 简化了代码维护，减少了状态不一致的潜在问题

- 简化CTask_类的begin方法
  - 移除lifeExtRatio参数，不再支持任务生命周期延长功能
  - 优化方法结构，只保留继续任务和正常开始两种逻辑
  - 添加任务继续运行的日志提示
  - 提高了代码可读性和维护性

### 2024-12-30
- 优化任务执行机制，修复重复执行BUG
  - 在_Page_类中添加onExit事件回调支持
  - 添加_pageExitEvt标志，通过页面退出事件控制任务执行
  - 在页面退出时触发onExit回调，更新_pageExitEvt状态
  - 任务只有在页面完全退出后才会执行下一次
  - 解决了页面切换过程中可能出现的任务重复执行问题
  - 提供了基于事件的任务执行控制机制，更加可靠和清晰

- 增强任务生命周期管理功能
  - 在begin方法中添加lifeExtendRatio参数，默认值为1
  - 支持在任务开始时动态延长任务生命周期
  - 生命周期延长比例适用于时间模式(正数)和次数模式(负数)
  - 保持原有符号，只增加绝对值大小
  - 添加日志记录，跟踪任务生命周期的变化

### 2024-12-28
- 新增计数器本地缓存功能，实现数据持久化
  - 计数器数据按天分开存储在本地JSON文件中
  - 应用启动时自动加载当天的计数数据
  - 应用退出时自动保存计数数据
  - 添加定期保存机制，每5分钟自动保存一次修改的计数数据
  - 使用_countersModified标记来跟踪计数器是否被修改
  - 优化计数器数据的存取逻辑，减少不必要的文件操作
  - 文件路径格式为data/counters/{应用名}_{日期}.json
  - 保持API兼容性，通过App.count(name)方法获取计数值

### 2024-12-26
- 优化计数器功能设计，改为实例级别管理
  - 将计数器从类级别静态字典改为每个应用实例的成员变量
  - 在App实例初始化时创建独立的_counters字典
  - 修改count和_increaseCount类方法，使其通过当前应用实例访问计数器
  - 直接在_setCurrentPage方法中操作实例级别的计数器
  - 在_doEvent方法中使用应用实例的计数器记录事件触发
  - 每个应用实例现在拥有独立的计数统计，互不干扰
  - 通过App.count(name)方法仍可方便地获取当前应用的计数值

### 2024-12-25
- 新增计数器功能，统计页面访问和事件触发次数
  - 在_App_类中添加_counters静态字典，用于存储各类计数
  - 实现count方法，用于获取指定名称的计数值
  - 添加_increaseCount内部方法，用于增加计数
  - 在_setCurrentPage方法中增加对页面访问次数的统计
  - 在_doEvent方法中增加对事件触发次数的统计
  - 页面计数使用"page_页面名"作为键名
  - 事件计数使用"event_事件名"作为键名
  - 通过App.count(name)方法可以获取任意名称的计数值

### 2024-12-21
- 增强屏幕信息命令的功能
  - 支持设置负数超时值，实现文本被查找到N次后自动清除的功能
  - 屏幕信息命令格式: `屏幕信息 文本内容 -N`，表示文本在被查找到N次后自动清除
  - 提升了屏幕模拟的智能性和易用性
  - 无需手动清理屏幕元素，系统会在达到指定查找次数后自动处理
  - 适用于需要精确控制屏幕元素生命周期的场景

### 2024-08-22
- 完善页面检测机制，增加页面类型区分
  - 新增ePageType枚举类，支持normal(正常页面)、alert(弹窗)和temp(临时页面)三种类型
  - 修改_Page_类的type属性，使用新的枚举类型替代原有字符串类型
  - 改进detectPage方法的检测逻辑，优先检测当前应用中的alert类型页面
  - 不再检测exitPages列表和其他应用的页面，保持导航逻辑的独立性
  - 明确了exit仅用于定义页面间跳转关系，不用于页面检测
  - 增加类型安全检查，确保页面类型设置正确
  - 提升了异常情况下的页面识别能力，特别是对弹窗的处理

### 2024-08-21
- 合并CJob_功能到CTask_类
  - 移除了独立的CJob_类，将其功能直接集成到CTask_类中
  - 添加了任务执行相关的属性：_pageName、_life、_interval、_isRunning、_lastExecTime
  - 增加了isExpired属性和_doWork方法，直接在CTask_中实现任务执行逻辑
  - 优化了begin方法，直接解析参数并执行页面跳转
  - 重构了update方法，实现了定时执行任务的功能
  - 重写了stop和complete方法，增加对任务结束脚本的处理
  - 添加了addScore方法，支持直接增加任务分数
  - 简化了整体代码结构，减少了不必要的对象创建和管理

### 2024-08-20
- 优化任务配置结构
  - 将任务配置改为字典格式，提高可读性和可维护性
  - _begin字段现在是字典格式，直接包含pageName、life、interval参数
  - 简化了_parseBeginScript方法，直接从字典中获取参数
  - 提供了标准化的task.json格式示例
  - 移除了复杂的正则表达式解析逻辑
  - 将配置文件task.json移至config目录下
  - 添加_getConfigPath方法，统一管理配置路径

### 2024-08-19
- 新增CJob_类用于任务的具体执行
  - 将任务执行逻辑独立为单独的类，提高代码复用性和可维护性
  - 支持配置任务目标页面、生命周期、执行间隔和结束脚本
  - 实现任务自动跳转到目标页面、定期执行和自动结束功能
  - 优化了CTask_类，通过解析begin脚本创建对应的CJob实例
  - 任务的begin, update和end工作现在由CJob_类负责处理
  - 添加了Create静态方法，方便创建CJob实例
  - 支持自动更新任务进度和分数，与服务端保持同步

### 2024-08-18
- 新增CTask_类用于客户端任务管理
  - 任务属性包含名称、所属APP、时间、进度、分数等
  - 支持任务配置从task.json加载和保存
  - 实现任务生命周期管理：开始、停止、更新、完成
  - 支持任务脚本执行，通过begin和exit属性配置
  - 任务状态与服务端同步，通过APP通信接口发送
  - 在_App_类中添加了任务管理接口：启动、获取、当前任务
  - APP定期在_update中调用当前任务的update方法

### 2023-10-13
- 新增Page类click方法，用于PC平台模拟Android端点击效果
  - 调用tools.click的同时，在PC平台额外执行指定操作
  - 支持三种操作格式：
    - < : 页面跳转到上一页
    - >pageName: 跳转到pageName指定的页面
    - +d: 收获d金币，如果d不是数字，则收获this.d金币
  - 提高了PC平台测试的真实性和便捷性
  - 简化了跨平台开发和调试流程

### 2023-10-12
- 增强页面timeout属性的功能
  - timeout配置值不再只是数字，而是支持字符串格式："等待时间长度&执行的操作"
  - 新增页面的_timeout和_timeoutOp属性，分别存储超时时间和超时操作
  - 在timeout的getter中实现lazy初始化，自动解析timeout字符串
  - 将timeout处理从App._update移动到Page.update中
  - 超时时执行指定的操作，如果没有指定操作则执行退出逻辑
  - 提高了页面超时处理的灵活性和可控性

### 2023-10-11
- 优化页面引用机制和安全性
  - 将exitPages改为私有变量_exitPages，通过属性访问器提供安全访问
  - 完善getInst方法实现，支持正确创建页面实例和配置复制
  - 优化参数处理，区分配置项和数据项
  - 简化App.getPage中的公共页面处理逻辑，直接返回公共页面
  - 修复了引用页面不存在时的错误日志类型

### 2023-10-10
- 优化页面配置和检测机制
  - 移除commonPages配置，改为使用更灵活的页面引用机制
  - 新增页面引用功能，支持在exit配置中使用#开头的引用页面
  - 引用格式：#引用页面名{参数JSON}，参数部分可选
  - 添加_Page_类的exitPages属性，存储当前页面可跳转的目标页面
  - 优化detectPage方法，只检测当前页面的exitPages中的页面，提高性能
  - 页面引用支持参数传递，可以根据不同场景定制页面行为
  - 引用页面只在公共页面中查找，确保引用的一致性

### 2023-10-09
- 增加应用公共页面配置功能
  - 在root配置中添加commonPages配置项，用于定义要加入到应用的公共页面
  - 修改_loadConfig方法，支持自动加载commonPages中定义的公共页面
  - 利用现有getPage方法的includeCommon参数加载公共页面
  - 公共页面会从TOP应用中复制并添加到当前应用
  - 提高了页面复用性，减少重复配置工作

### 2023-10-08
- 优化_doEvent方法实现
  - 移除了不再需要的子页面事件（P-页面名格式）处理逻辑
  - 简化了用户事件检查，确保app.userEvents始终存在
  - 重构了条件检查流程，提高了代码可读性
  - 统一了execute变量的初始化和设置逻辑
  - 为延时和无条件执行添加了明确的execute=True设置

### 2023-10-07
- 进一步优化用户事件处理机制
  - 将用户事件逻辑移入_doEvent方法，统一事件处理流程
  - 简化Page.update方法，不再单独检查用户事件
  - 减少了代码冗余，提高了事件处理效率
  - 优化了_doEvent方法的流程，使其处理逻辑更清晰

### 2023-10-06
- 优化了事件处理和用户事件机制
  - 重构了事件处理流程，移除了重复的检查逻辑
  - 将userEvents从页面属性改为应用实例变量，使其成为字符串列表
  - 添加了App.addUserEvent和App.clearUserEvents方法，用于管理用户事件
  - 在App._update中添加自动清空用户事件的逻辑，防止事件被重复触发
  - 简化了Page.update方法，直接调用_doEvent处理事件逻辑
  - 提高了用户事件处理的效率和可靠性
  - 减少了冗余代码，提升了代码可维护性

### 2023-09-02
- 重构了页面自动执行逻辑设计和优化
  - 添加了App._update方法检测当前页面并调用页面更新函数
  - 添加了全局App.update循环方法实现自动检测应用和页面
  - 实现了Page.update方法处理事件检测、页面跳转和用户事件
  - 将页面跳转处理从Page.update移至App._update
  - 改进了App.goPage方法，使其只设置目标页面
  - 实现了路径跳转，每次更新循环只跳转一步
  - 简化了路径缓存，直接存储当前目标路径
  - 优化了路径判断逻辑，检测当前页面是否在预定路径中
  - 在事件匹配过程中同步检查用户事件
  - 用户事件可以直接触发匹配的KEY事件
  - 移除了子页面(children)相关的代码
  - 删除了_startChild和_stopAllChildren方法

### 2023-09-01
- 优化了页面更新机制
  - 移除了Page.update中的循环逻辑，简化为单次执行
  - 适应App驱动的更新模式，提高执行效率
  - 修复了超时计算逻辑，使用页面创建时间而非更新开始时间
  - 简化了代码结构，提高了可维护性
  - 减少了内存和CPU资源消耗

### 2023-08-30
- 改进了用户事件处理逻辑
  - 在事件匹配过程中同步检查用户事件，提高响应效率
  - 用户事件现在可以直接触发匹配的KEY事件，无需额外处理
  - 精简了事件处理代码，减少冗余检查
  - 更明确的事件处理日志，便于调试
  - 提高了用户交互反馈的及时性和准确性

### 2023-08-25
- 进一步简化页面跳转逻辑
  - 将路径缓存从键值对改为直接存储当前目标路径
  - 移除不必要的缓存查找和路径重计算
  - 优化了路径判断逻辑，清晰检测当前页面是否在预定路径中
  - 减少了冗余代码，提高了执行效率
  - 更明确的错误处理，当页面不在路径上时直接报错

### 2023-08-20
- 优化了页面跳转性能
  - 添加路径缓存机制，避免重复计算页面间路径
  - 简化了goPage函数逻辑，专注于设置目标页面和路径缓存
  - 在App._update中利用缓存路径进行页面跳转
  - 增加缓存失效处理，当路径跳转失败时自动清除缓存
  - 大幅提高了复杂页面导航的性能和响应速度

### 2023-08-15
- 优化了页面跳转逻辑
  - 将页面跳转处理从Page.update移至App._update
  - 改进了App.goPage方法，使其只设置目标页面而不直接执行跳转
  - 在App._update中实现路径跳转，每次更新循环只跳转一步
  - 增强了页面间跳转的稳定性和效率，支持复杂路径自动导航
  - 优化了错误处理和日志记录，更易于调试和监控

### 2023-08-10
- 新增页面自动执行循环逻辑
  - 添加应用级_update方法，负责检测当前页面并调用页面更新函数
  - 新增全局update循环方法，实现自动检测当前应用和页面
  - 添加页面update方法，实现三大功能：
    - 检测事件是否满足条件KEY，使用tools.check检查并执行ACTION
    - 通过应用的_targetPage属性处理页面跳转逻辑
    - 检测用户事件，通过event.items()处理用户交互
  - 修改App.goPage方法，使用_targetPage属性设置跳转目标
  - 提高了应用自动化执行的灵活性和稳定性

### 2023-07-26
- 增强matchText函数功能
  - 支持&（与）和|（或）逻辑操作符，实现复杂条件匹配
  - 添加空括号()继承功能，可以继承前一个条件的区域范围
  - 示例："推荐(x300,500)&新剧()&VIP抢先|排行榜"
  - 完善逻辑表达式解析和评估算法
  - 提高了屏幕元素检测的灵活性和精确性

### 2023-07-25
- 增加了Page页面的父子关系支持
  - 添加了parent成员变量，用于存储父页面引用
  - 添加了setParent方法，用于设置父子页面关系并自动建立父页面退出到子页面的链接
  - 修改了getInst方法，支持在创建页面时设置父页面
  - 修改了_begin方法，在执行页面前确保与父页面的关系已正确设置

### 2023-12-10
- 改进了CRun模块的页面重入判断逻辑
- 现在批处理任务会根据页面的运行状态来判断是否可以重新进入，而不是简单地比较当前页面是否为目标页面
- 在Page类中添加了_running状态标志，用于跟踪页面是否正在运行
- 页面的begin方法会将_running设为True，end方法和_end方法会在页面结束时将_running设为False

### 2024-11-29
- 修复正则表达式匹配方法中的参数错误
  - 移除`fullmatch`方法中不正确的`re.IGNORECASE`参数
  - 将忽略大小写标志移至`re.compile`阶段
  - 解决了导致命令无法匹配的关键问题
  - 正确处理了正则表达式的编译和匹配过程

### 2024-11-30
- 优化命令匹配逻辑，简化代码结构
  - 移除了不必要的正则表达式匹配备用路径
  - 统一使用预编译的正则表达式进行命令匹配
  - 减少了条件判断，提高了执行效率
  - 简化了错误处理流程

### 2024-11-30
- 修复命令参数间空格处理问题
  - 使用已有的专用方法`processParamSpaces`处理参数间空格
  - 解决了类似`current page aa`这样多参数命令无法匹配的问题
  - 统一了参数空格处理逻辑，提高了代码复用性
  - 确保命令模式中参数之间都有`\s*`匹配空白字符

### 2024-12-01
- 修复命令参数空格处理方法
  - 修正`processParamSpaces`方法，确保保留原始参数匹配模式
  - 采用迭代方式处理参数间空格，避免修改参数本身
  - 只在纯空白的参数间距添加`\s*`匹配，保留其他内容
  - 提高了处理的准确性，不再修改参数的实际匹配字符
  - 增加了对参数数量的检查，优化处理流程

### 2023-11-21
- 扩展了宏变量替换功能，增加宏命令支持
  - 添加了宏命令映射表(MACRO_MAP)，支持常用命令的简化表示
  - 宏命令支持正则表达式捕获组，可以提取参数
  - 支持的宏命令包括：
    - `>pageName`: 跳转到指定页面，等同于`app.gotoPage(pageName)`
    - `<<`: 返回主页，等同于`app.home()`
    - `<`: 返回上一页，等同于`app.last().back()`
    - `->text pageName`: 点击文本并跳转，等同于`it.click('text','@app.gotoPage(pageName)')`
  - 优化了宏替换逻辑，先进行符号替换，将全角符号转为半角
  - 宏命令使用全匹配模式，忽略大小写

### 2023-11-20
- 添加了宏变量支持，使用格式 `%变量名` 可在文本匹配和脚本中引用变量值
- 简化了命令处理逻辑，移除了`:开头`的特殊命令支持
- 优化了代码结构，提高了可维护性

### 2024-03-21
- 优化toast配置功能
  - 将toast配置名称改为toasts，更符合复数形式规范
  - 将toast检查逻辑从_update方法移至detectPage方法中
  - 在检测alert类型页面后立即检查toast配置
  - 删除了_Page_类中不再使用的schedule相关代码
  - 简化了配置结构，提高了代码可维护性
  - 优化了toast检测的时机，使其与页面检测逻辑更加协调

### 功能更新日志

## 2024-03-21
1. 任务系统改造
   - 将expectedScore字段改为life字段，用于表示任务的预期生命
   - life字段含义：
     - 负数：表示任务可执行次数
     - 正数：表示任务可执行时间长度（秒）
     - 0：表示无生命约束，任务可以一直执行
   - 移除appName字段，将应用名称整合到taskName中
   - 优化任务显示格式，简化任务ID显示

### 之前的更新
<!-- 此处保留之前的更新记录 -->

### 2024-05-30
- 重构日志系统，解决循环引用问题
  - 将LogModel_类从SModels模块移至_Log_模块内部
  - 优化日志ID计算算法，现在基于tag+level+time+message计算哈希值
  - 改进日志查找机制，采用线性搜索查找匹配ID的日志
  - 修复了缓存数据查找和更新相关的bug
  - 完善了数据库存储检查机制，避免重复插入
  - 重新启用日志过滤和日期获取功能
  - 增强Socket通信的健壮性，添加更多空值检查
  - 优化了日志数据结构和格式化方法

### 2024-05-27
- 优化服务器日志系统
  - 改进日志缓存机制，缓存数据改为LogModel数组而非字典
  - 实现按需保存到数据库的功能，只有显式调用save方法时才同步到数据库
  - 新增日志ID计算算法，ID基于tag+level+message的哈希值
  - 添加_cacheModified标志，跟踪日志缓存是否被修改
  - 优化日志加载和过滤方法，直接操作LogModel对象
  - 增强前端通信安全性，添加各种防御性检查
  - 简化了日志重复性检测逻辑，使用哈希ID快速判断
  - 添加日志备份功能，在保存到数据库的同时备份到JSON文件

### 2024-05-25
- 统一使用S2B_sheetUpdate事件机制
- 确保所有设备/任务/日志相关的增删改操作都触发S2B_sheetUpdate事件，实现前端数据实时更新

### 2024-05-18
- 完善了表格数据处理功能
- 添加了设备、任务和日志的表格数据加载API

### 2024-12-20
- 添加了设备实时状态监控
- 优化了任务调度算法

### 2024-12-15
- 完善了任务管理系统
- 添加了日志记录功能

### 2024-12-10
- 初始化项目基础架构
- 添加了基本的设备管理功能
- 实现了Socket.IO通信框架

### 2023-07-15
- 修复了一些已知问题
- 添加了新的API支持

### 2023-07-30
- 新增自动连接功能
- 优化了日志显示

### 2023-11-15
- 修复系统兼容性问题
- 优化操作界面

### 2023-12-25
- 修复网络连接稳定性问题
- 增强安全性

### 2024-07-15
- 修复表格初始化问题：解决在表格完全构建前调用getHeaderFilters方法导致的错误
- 优化表格数据加载流程，确保在表格初始化完成后再加载数据
- 改进过滤器处理逻辑，增强表格组件的稳定性

## 2023-11-15 更新日志

### 服务端任务管理优化
1. 重构了STask_类，添加了任务缓存功能，不再依赖STaskMgr
2. 添加了任务缓存列表和缓存管理机制，控制服务器内存压力
3. 实现了get()方法，支持按设备ID、任务名称和日期获取任务，支持自动创建
4. 实现了gets()方法，支持按设备ID和日期批量获取任务
5. 添加了handleB2SLoadTasks()事件处理，返回缓存中的任务数据

## 2023-11-16 更新日志

### 任务缓存机制优化
1. 重构了STask_.gets()方法，移除了deviceId参数，以日期为单位缓存任务
2. 添加了最近一次缓存日期的记录功能，避免重复查询数据库
3. 优化了缓存逻辑，相同日期直接返回缓存，不同日期清除缓存并重新加载
4. 改进了handleB2SLoadTasks方法，支持在内存中按设备ID筛选任务
5. 提高了系统性能，减少了数据库查询次数

## 2023-07-14
- 初始版本
- 支持基础自动化操作

## 2023-08-21
- 增加支持多任务并行执行
- 优化日志处理

## 2023-09-30
- 增加图像识别功能
- 支持自定义脚本运行

## 2023-11-18
- 优化UI界面
- 增加任务监控功能

## 2024-03-05
- 修复脚本运行Bug
- 增强设备管理功能

## 2024-06-11
- 集成命令输入区域到表格页面(sheet.html)
- 保留了命令历史和上下键命令导航功能
- 从任务表格中移除了备注列

## 2024-06-12
- 优化sheet.html页面的代码结构
- 移除对logManager.js的依赖，使用sheet.js自身的命令历史功能
- 减少文件依赖，简化代码结构

## 2024-06-13
- 优化表格分页功能
- 日志表格自动滚动到最后一页，除非用户手动翻页
- 所有表格在只有一页数据时自动隐藏分页按钮
- 添加用户翻页状态跟踪，优化用户体验

## 2024-06-14
- 增加表格多选功能和命令目标管理
- 所有表格支持多选，并在切换表格时保持选择状态
- 设备表格中选中的设备作为命令的目标设备
- 如果没有选中设备，自动使用最后一次连接的设备
- 增加设备状态更新监听，实时追踪最新连接的设备

### 2023-07-05
- 初始化项目结构
- 添加基本设备管理功能

### 2023-07-17
- 优化数据库连接管理
- 添加设备分组功能

### 2024-07-04
- 合并DeviceModel和SDevice_类，将所有设备管理功能整合到一个类中
- 优化了数据库模型，减少了冗余代码
- 简化了属性访问，提高了代码可维护性

### 2024-06-09
- 日志表的标签列过滤器现在会根据当前所有日志的tag字段动态生成（去重），不再是固定选项。

### 2024-03-21
- 优化表格过滤功能：
  - 将日期过滤器改为服务端过滤，其他过滤器保持本地过滤
  - 只有日期过滤器变化时才会向服务端请求新数据
  - 启用本地实时过滤，提高其他过滤器的响应速度
  - 减少了服务器负载，优化了数据传输量
