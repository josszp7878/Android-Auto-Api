# Android Auto API

## 更新日志

### 2024-12-31
- 优化任务管理机制，修复任务暂停和恢复问题
  - 修改CTask_类的begin方法，确保在恢复任务时重置_lastTime并调用_goPage
  - 优化_refreshProgress方法，支持任务暂停后再次开始时累计计算进度
  - 在时间模式下，使用当前会话运行时间累加到总进度中
  - 在次数模式下，利用_execCount的累加特性计算进度
  - 增强了stop方法的注释，明确说明暂停任务的功能和返回值
  - 提高了任务暂停和恢复功能的可靠性和准确性

- 统一客户端和服务端任务状态管理
  - 将TaskState枚举类移至_G.py中作为共享枚举
  - 修改CTask_类和STask_类，统一使用_G中的TaskState枚举
  - 将toTaskId方法从_Tools移至_G中，保证任务ID一致性
  - 修改_end方法，根据任务返回结果决定是设置SUCCESS还是FAILED状态
  - 提高了客户端和服务端任务状态的一致性
  - 简化了代码维护，减少了状态不一致的潜在问题

- 简化CTask_类的begin方法
  - 移除lifeExtRatio参数，不再支持任务生命周期延长功能
  - 优化方法结构，只保留继续任务和正常开始两种逻辑
  - 添加任务继续运行的日志提示
  - 提高了代码可读性和维护性

### 2024-12-30
- 优化任务执行机制，修复重复执行BUG
  - 在_Page_类中添加onExit事件回调支持
  - 添加_pageExitEvt标志，通过页面退出事件控制任务执行
  - 在页面退出时触发onExit回调，更新_pageExitEvt状态
  - 任务只有在页面完全退出后才会执行下一次
  - 解决了页面切换过程中可能出现的任务重复执行问题
  - 提供了基于事件的任务执行控制机制，更加可靠和清晰

- 增强任务生命周期管理功能
  - 在begin方法中添加lifeExtendRatio参数，默认值为1
  - 支持在任务开始时动态延长任务生命周期
  - 生命周期延长比例适用于时间模式(正数)和次数模式(负数)
  - 保持原有符号，只增加绝对值大小
  - 添加日志记录，跟踪任务生命周期的变化

### 2024-12-28
- 新增计数器本地缓存功能，实现数据持久化
  - 计数器数据按天分开存储在本地JSON文件中
  - 应用启动时自动加载当天的计数数据
  - 应用退出时自动保存计数数据
  - 添加定期保存机制，每5分钟自动保存一次修改的计数数据
  - 使用_countersModified标记来跟踪计数器是否被修改
  - 优化计数器数据的存取逻辑，减少不必要的文件操作
  - 文件路径格式为data/counters/{应用名}_{日期}.json
  - 保持API兼容性，通过App.count(name)方法获取计数值

### 2024-12-26
- 优化计数器功能设计，改为实例级别管理
  - 将计数器从类级别静态字典改为每个应用实例的成员变量
  - 在App实例初始化时创建独立的_counters字典
  - 修改count和_increaseCount类方法，使其通过当前应用实例访问计数器
  - 直接在_setCurrentPage方法中操作实例级别的计数器
  - 在_doEvent方法中使用应用实例的计数器记录事件触发
  - 每个应用实例现在拥有独立的计数统计，互不干扰
  - 通过App.count(name)方法仍可方便地获取当前应用的计数值

### 2024-12-25
- 新增计数器功能，统计页面访问和事件触发次数
  - 在_App_类中添加_counters静态字典，用于存储各类计数
  - 实现count方法，用于获取指定名称的计数值
  - 添加_increaseCount内部方法，用于增加计数
  - 在_setCurrentPage方法中增加对页面访问次数的统计
  - 在_doEvent方法中增加对事件触发次数的统计
  - 页面计数使用"page_页面名"作为键名
  - 事件计数使用"event_事件名"作为键名
  - 通过App.count(name)方法可以获取任意名称的计数值

### 2024-12-21
- 增强屏幕信息命令的功能
  - 支持设置负数超时值，实现文本被查找到N次后自动清除的功能
  - 屏幕信息命令格式: `屏幕信息 文本内容 -N`，表示文本在被查找到N次后自动清除
  - 提升了屏幕模拟的智能性和易用性
  - 无需手动清理屏幕元素，系统会在达到指定查找次数后自动处理
  - 适用于需要精确控制屏幕元素生命周期的场景

### 2024-08-22
- 完善页面检测机制，增加页面类型区分
  - 新增ePageType枚举类，支持normal(正常页面)、alert(弹窗)和temp(临时页面)三种类型
  - 修改_Page_类的type属性，使用新的枚举类型替代原有字符串类型
  - 改进detectPage方法的检测逻辑，优先检测当前应用中的alert类型页面
  - 不再检测exitPages列表和其他应用的页面，保持导航逻辑的独立性
  - 明确了exit仅用于定义页面间跳转关系，不用于页面检测
  - 增加类型安全检查，确保页面类型设置正确
  - 提升了异常情况下的页面识别能力，特别是对弹窗的处理

### 2024-08-21
- 合并CJob_功能到CTask_类
  - 移除了独立的CJob_类，将其功能直接集成到CTask_类中
  - 添加了任务执行相关的属性：_pageName、_life、_interval、_isRunning、_lastExecTime
  - 增加了isExpired属性和_doWork方法，直接在CTask_中实现任务执行逻辑
  - 优化了begin方法，直接解析参数并执行页面跳转
  - 重构了update方法，实现了定时执行任务的功能
  - 重写了stop和complete方法，增加对任务结束脚本的处理
  - 添加了addScore方法，支持直接增加任务分数
  - 简化了整体代码结构，减少了不必要的对象创建和管理

### 2024-08-20
- 优化任务配置结构
  - 将任务配置改为字典格式，提高可读性和可维护性
  - _begin字段现在是字典格式，直接包含pageName、life、interval参数
  - 简化了_parseBeginScript方法，直接从字典中获取参数
  - 提供了标准化的task.json格式示例
  - 移除了复杂的正则表达式解析逻辑
  - 将配置文件task.json移至config目录下
  - 添加_getConfigPath方法，统一管理配置路径

### 2024-08-19
- 新增CJob_类用于任务的具体执行
  - 将任务执行逻辑独立为单独的类，提高代码复用性和可维护性
  - 支持配置任务目标页面、生命周期、执行间隔和结束脚本
  - 实现任务自动跳转到目标页面、定期执行和自动结束功能
  - 优化了CTask_类，通过解析begin脚本创建对应的CJob实例
  - 任务的begin, update和end工作现在由CJob_类负责处理
  - 添加了Create静态方法，方便创建CJob实例
  - 支持自动更新任务进度和分数，与服务端保持同步

### 2024-08-18
- 新增CTask_类用于客户端任务管理
  - 任务属性包含名称、所属APP、时间、进度、分数等
  - 支持任务配置从task.json加载和保存
  - 实现任务生命周期管理：开始、停止、更新、完成
  - 支持任务脚本执行，通过begin和exit属性配置
  - 任务状态与服务端同步，通过APP通信接口发送
  - 在_App_类中添加了任务管理接口：启动、获取、当前任务
  - APP定期在_update中调用当前任务的update方法

### 2023-10-13
- 新增Page类click方法，用于PC平台模拟Android端点击效果
  - 调用tools.click的同时，在PC平台额外执行指定操作
  - 支持三种操作格式：
    - < : 页面跳转到上一页
    - >pageName: 跳转到pageName指定的页面
    - +d: 收获d金币，如果d不是数字，则收获this.d金币
  - 提高了PC平台测试的真实性和便捷性
  - 简化了跨平台开发和调试流程

### 2023-10-12
- 增强页面timeout属性的功能
  - timeout配置值不再只是数字，而是支持字符串格式："等待时间长度&执行的操作"
  - 新增页面的_timeout和_timeoutOp属性，分别存储超时时间和超时操作
  - 在timeout的getter中实现lazy初始化，自动解析timeout字符串
  - 将timeout处理从App._update移动到Page.update中
  - 超时时执行指定的操作，如果没有指定操作则执行退出逻辑
  - 提高了页面超时处理的灵活性和可控性

### 2023-10-11
- 优化页面引用机制和安全性
  - 将exitPages改为私有变量_exitPages，通过属性访问器提供安全访问
  - 完善getInst方法实现，支持正确创建页面实例和配置复制
  - 优化参数处理，区分配置项和数据项
  - 简化App.getPage中的公共页面处理逻辑，直接返回公共页面
  - 修复了引用页面不存在时的错误日志类型

### 2023-10-10
- 优化页面配置和检测机制
  - 移除commonPages配置，改为使用更灵活的页面引用机制
  - 新增页面引用功能，支持在exit配置中使用#开头的引用页面
  - 引用格式：#引用页面名{参数JSON}，参数部分可选
  - 添加_Page_类的exitPages属性，存储当前页面可跳转的目标页面
  - 优化detectPage方法，只检测当前页面的exitPages中的页面，提高性能
  - 页面引用支持参数传递，可以根据不同场景定制页面行为
  - 引用页面只在公共页面中查找，确保引用的一致性

### 2023-10-09
- 增加应用公共页面配置功能
  - 在root配置中添加commonPages配置项，用于定义要加入到应用的公共页面
  - 修改_loadConfig方法，支持自动加载commonPages中定义的公共页面
  - 利用现有getPage方法的includeCommon参数加载公共页面
  - 公共页面会从TOP应用中复制并添加到当前应用
  - 提高了页面复用性，减少重复配置工作

### 2023-10-08
- 优化_doEvent方法实现
  - 移除了不再需要的子页面事件（P-页面名格式）处理逻辑
  - 简化了用户事件检查，确保app.userEvents始终存在
  - 重构了条件检查流程，提高了代码可读性
  - 统一了execute变量的初始化和设置逻辑
  - 为延时和无条件执行添加了明确的execute=True设置

### 2023-10-07
- 进一步优化用户事件处理机制
  - 将用户事件逻辑移入_doEvent方法，统一事件处理流程
  - 简化Page.update方法，不再单独检查用户事件
  - 减少了代码冗余，提高了事件处理效率
  - 优化了_doEvent方法的流程，使其处理逻辑更清晰

### 2023-10-06
- 优化了事件处理和用户事件机制
  - 重构了事件处理流程，移除了重复的检查逻辑
  - 将userEvents从页面属性改为应用实例变量，使其成为字符串列表
  - 添加了App.addUserEvent和App.clearUserEvents方法，用于管理用户事件
  - 在App._update中添加自动清空用户事件的逻辑，防止事件被重复触发
  - 简化了Page.update方法，直接调用_doEvent处理事件逻辑
  - 提高了用户事件处理的效率和可靠性
  - 减少了冗余代码，提升了代码可维护性

### 2023-09-02
- 重构了页面自动执行逻辑设计和优化
  - 添加了App._update方法检测当前页面并调用页面更新函数
  - 添加了全局App.update循环方法实现自动检测应用和页面
  - 实现了Page.update方法处理事件检测、页面跳转和用户事件
  - 将页面跳转处理从Page.update移至App._update
  - 改进了App.goPage方法，使其只设置目标页面
  - 实现了路径跳转，每次更新循环只跳转一步
  - 简化了路径缓存，直接存储当前目标路径
  - 优化了路径判断逻辑，检测当前页面是否在预定路径中
  - 在事件匹配过程中同步检查用户事件
  - 用户事件可以直接触发匹配的KEY事件
  - 移除了子页面(children)相关的代码
  - 删除了_startChild和_stopAllChildren方法

### 2023-09-01
- 优化了页面更新机制
  - 移除了Page.update中的循环逻辑，简化为单次执行
  - 适应App驱动的更新模式，提高执行效率
  - 修复了超时计算逻辑，使用页面创建时间而非更新开始时间
  - 简化了代码结构，提高了可维护性
  - 减少了内存和CPU资源消耗

### 2023-08-30
- 改进了用户事件处理逻辑
  - 在事件匹配过程中同步检查用户事件，提高响应效率
  - 用户事件现在可以直接触发匹配的KEY事件，无需额外处理
  - 精简了事件处理代码，减少冗余检查
  - 更明确的事件处理日志，便于调试
  - 提高了用户交互反馈的及时性和准确性

### 2023-08-25
- 进一步简化页面跳转逻辑
  - 将路径缓存从键值对改为直接存储当前目标路径
  - 移除不必要的缓存查找和路径重计算
  - 优化了路径判断逻辑，清晰检测当前页面是否在预定路径中
  - 减少了冗余代码，提高了执行效率
  - 更明确的错误处理，当页面不在路径上时直接报错

### 2023-08-20
- 优化了页面跳转性能
  - 添加路径缓存机制，避免重复计算页面间路径
  - 简化了goPage函数逻辑，专注于设置目标页面和路径缓存
  - 在App._update中利用缓存路径进行页面跳转
  - 增加缓存失效处理，当路径跳转失败时自动清除缓存
  - 大幅提高了复杂页面导航的性能和响应速度

### 2023-08-15
- 优化了页面跳转逻辑
  - 将页面跳转处理从Page.update移至App._update
  - 改进了App.goPage方法，使其只设置目标页面而不直接执行跳转
  - 在App._update中实现路径跳转，每次更新循环只跳转一步
  - 增强了页面间跳转的稳定性和效率，支持复杂路径自动导航
  - 优化了错误处理和日志记录，更易于调试和监控

### 2023-08-10
- 新增页面自动执行循环逻辑
  - 添加应用级_update方法，负责检测当前页面并调用页面更新函数
  - 新增全局update循环方法，实现自动检测当前应用和页面
  - 添加页面update方法，实现三大功能：
    - 检测事件是否满足条件KEY，使用tools.check检查并执行ACTION
    - 通过应用的_targetPage属性处理页面跳转逻辑
    - 检测用户事件，通过event.items()处理用户交互
  - 修改App.goPage方法，使用_targetPage属性设置跳转目标
  - 提高了应用自动化执行的灵活性和稳定性

### 2023-07-26
- 增强matchText函数功能
  - 支持&（与）和|（或）逻辑操作符，实现复杂条件匹配
  - 添加空括号()继承功能，可以继承前一个条件的区域范围
  - 示例："推荐(x300,500)&新剧()&VIP抢先|排行榜"
  - 完善逻辑表达式解析和评估算法
  - 提高了屏幕元素检测的灵活性和精确性

### 2023-07-25
- 增加了Page页面的父子关系支持
  - 添加了parent成员变量，用于存储父页面引用
  - 添加了setParent方法，用于设置父子页面关系并自动建立父页面退出到子页面的链接
  - 修改了getInst方法，支持在创建页面时设置父页面
  - 修改了_begin方法，在执行页面前确保与父页面的关系已正确设置

### 2023-12-10
- 改进了CRun模块的页面重入判断逻辑
- 现在批处理任务会根据页面的运行状态来判断是否可以重新进入，而不是简单地比较当前页面是否为目标页面
- 在Page类中添加了_running状态标志，用于跟踪页面是否正在运行
- 页面的begin方法会将_running设为True，end方法和_end方法会在页面结束时将_running设为False

### 2024-11-29
- 修复正则表达式匹配方法中的参数错误
  - 移除`fullmatch`方法中不正确的`re.IGNORECASE`参数
  - 将忽略大小写标志移至`re.compile`阶段
  - 解决了导致命令无法匹配的关键问题
  - 正确处理了正则表达式的编译和匹配过程

### 2024-11-30
- 优化命令匹配逻辑，简化代码结构
  - 移除了不必要的正则表达式匹配备用路径
  - 统一使用预编译的正则表达式进行命令匹配
  - 减少了条件判断，提高了执行效率
  - 简化了错误处理流程

### 2024-11-30
- 修复命令参数间空格处理问题
  - 使用已有的专用方法`processParamSpaces`处理参数间空格
  - 解决了类似`current page aa`这样多参数命令无法匹配的问题
  - 统一了参数空格处理逻辑，提高了代码复用性
  - 确保命令模式中参数之间都有`\s*`匹配空白字符

### 2024-12-01
- 修复命令参数空格处理方法
  - 修正`processParamSpaces`方法，确保保留原始参数匹配模式
  - 采用迭代方式处理参数间空格，避免修改参数本身
  - 只在纯空白的参数间距添加`\s*`匹配，保留其他内容
  - 提高了处理的准确性，不再修改参数的实际匹配字符
  - 增加了对参数数量的检查，优化处理流程

### 2023-11-21
- 扩展了宏变量替换功能，增加宏命令支持
  - 添加了宏命令映射表(MACRO_MAP)，支持常用命令的简化表示
  - 宏命令支持正则表达式捕获组，可以提取参数
  - 支持的宏命令包括：
    - `>pageName`: 跳转到指定页面，等同于`app.gotoPage(pageName)`
    - `<<`: 返回主页，等同于`app.home()`
    - `<`: 返回上一页，等同于`app.last().back()`
    - `->text pageName`: 点击文本并跳转，等同于`it.click('text','@app.gotoPage(pageName)')`
  - 优化了宏替换逻辑，先进行符号替换，将全角符号转为半角
  - 宏命令使用全匹配模式，忽略大小写

### 2023-11-20
- 添加了宏变量支持，使用格式 `%变量名` 可在文本匹配和脚本中引用变量值
- 简化了命令处理逻辑，移除了`:开头`的特殊命令支持
- 优化了代码结构，提高了可维护性

### 2024-03-21
- 优化toast配置功能
  - 将toast配置名称改为toasts，更符合复数形式规范
  - 将toast检查逻辑从_update方法移至detectPage方法中
  - 在检测alert类型页面后立即检查toast配置
  - 删除了_Page_类中不再使用的schedule相关代码
  - 简化了配置结构，提高了代码可维护性
  - 优化了toast检测的时机，使其与页面检测逻辑更加协调

### 之前的更新
<!-- 此处保留之前的更新记录 -->
